# Render Deployment Configuration Guide

## Overview

This guide explains the production-ready configuration for deploying E-COMPTA-IA-LIGHT on Render.

## Architecture

The application is deployed as two separate services on Render:

1. **Backend Service** (Java/Spring Boot) - ecompta-backend
2. **Frontend Service** (Static React App) - ecompta-frontend
3. **PostgreSQL Database** - ecompta-db

## Configuration Files

### 1. render.yaml (Automatic Deployment)

The `render.yaml` file in the project root contains the complete configuration for automatic deployment via Render Blueprint.

**Key Features:**
- Java environment for backend (not Docker)
- Static site for frontend (not Docker)
- Automatic database connection setup
- Health checks enabled
- Free tier configuration

### 2. Backend Configuration

#### Application Configuration (`backend/src/main/resources/application-prod.yml`)

**Features:**
- PostgreSQL database connection with HikariCP connection pooling
- Actuator endpoints for health monitoring
- Production-optimized logging
- Port configuration from environment variable
- H2 console disabled for security

**Environment Variables Required:**
- `SPRING_PROFILES_ACTIVE=prod`
- `JWT_SECRET` (auto-generated by Render)
- `JWT_EXPIRATION=86400000` (24 hours)
- Database variables (auto-injected from database service)

#### Security Configuration

**CORS Configuration** (`WebConfig.java`):
- Allows requests from Render frontend domain
- Configured for API endpoints only
- Credentials support enabled

**Security Endpoints** (`SecurityConfig.java`):
- `/actuator/health` - Public health check
- `/actuator/info` - Public info endpoint
- `/api/auth/**` - Public authentication endpoints

#### Maven Configuration (`pom.xml`)

**Production Profile:**
```bash
mvn clean package -DskipTests -Pprod
```

**Dependencies Added:**
- `spring-boot-starter-actuator` - Health monitoring
- HikariCP (included in Spring Boot starter)

### 3. Frontend Configuration

#### Package Configuration (`frontend-app/package.json`)

**Key Changes:**
- `"homepage": "."` - Enables relative paths for static deployment

#### Environment Configuration (`frontend-app/.env.production`)

```env
REACT_APP_API_URL=https://ecompta-backend.onrender.com
```

This ensures the frontend connects to the correct backend service.

#### SPA Routing (`frontend-app/public/_redirects`)

```
/* /index.html 200
```

This file enables client-side routing for the React application on Render's static hosting.

#### HTML Metadata (`frontend-app/public/index.html`)

Updated with:
- Proper title: "E-COMPTA-IA-LIGHT - Comptabilit√© Intelligente"
- SEO-friendly meta description
- Keywords for better discoverability

## Deployment Process

### Automatic Deployment (Recommended)

1. Push changes to GitHub
2. In Render Dashboard:
   - Go to "Blueprints"
   - Click "New Blueprint Instance"
   - Connect your repository
   - Select the branch
3. Render will automatically:
   - Create the database
   - Deploy the backend
   - Deploy the frontend
   - Link all services together

### Manual Deployment (Alternative)

If you prefer manual setup:

#### Database
1. Create PostgreSQL database: "ecompta-db"
2. Note the connection details

#### Backend Service
1. New Web Service
2. Environment: Java
3. Build Command: `cd backend && mvn clean package -DskipTests -Pprod`
4. Start Command: `cd backend && java -Dserver.port=$PORT -Dspring.profiles.active=prod -jar target/*.jar`
5. Add environment variables (see render.yaml for complete list)
6. Link to database

#### Frontend Service
1. New Static Site
2. Build Command: `cd frontend-app && npm install && npm run build`
3. Publish Directory: `frontend-app/build`
4. Add environment variable: `REACT_APP_API_URL=https://ecompta-backend.onrender.com`
5. Rewrite rules are handled by `_redirects` file

## Health Monitoring

The backend exposes health check endpoints:

- **Health:** `https://ecompta-backend.onrender.com/actuator/health`
- **Info:** `https://ecompta-backend.onrender.com/actuator/info`

Render automatically monitors the `/actuator/health` endpoint and will restart the service if it becomes unhealthy.

## Build Verification

### Backend Build Test

```bash
cd backend
mvn clean package -DskipTests -Pprod
```

**Expected Output:**
- BUILD SUCCESS
- JAR file: `target/ecompta-ia-light-2.0.0.jar` (~60MB)
- Includes actuator dependencies

### Frontend Build Test

```bash
cd frontend-app
npm install
npm run build
```

**Expected Output:**
- Compiled successfully
- Build folder created with optimized assets
- `_redirects` file included in build
- Assets use relative paths (./static/...)

## Troubleshooting

### Frontend Shows Blank Page

**Check:**
1. Build logs for errors
2. Browser console for API connection errors
3. CORS configuration in backend
4. `REACT_APP_API_URL` environment variable

### Backend Deployment Fails

**Check:**
1. Build logs for compilation errors
2. Database connection environment variables
3. `JWT_SECRET` is set
4. Maven build completes successfully

### Database Connection Issues

**Check:**
1. Database service is running
2. Environment variables are correctly linked
3. PostgreSQL version compatibility
4. Connection pool settings

### Health Check Failing

**Check:**
1. `/actuator/health` endpoint is accessible
2. Security configuration allows public access
3. Backend is fully started (check logs)

## Performance Optimization

### Backend
- HikariCP connection pooling (max 10 connections)
- JVM heap size: -Xmx512m -Xms256m
- Connection timeout: 30 seconds
- Idle timeout: 10 minutes

### Frontend
- Gzipped assets
- Code splitting with lazy loading
- Optimized production build
- Static asset caching

## Security Considerations

1. **JWT Secret**: Auto-generated by Render (secure)
2. **CORS**: Restricted to frontend domain
3. **H2 Console**: Disabled in production
4. **HTTPS**: Enforced by Render
5. **Database**: Isolated within Render network
6. **Environment Variables**: Stored securely by Render

## Support

For issues specific to:
- **Render Platform**: Check Render's status page and documentation
- **Application Code**: Check application logs in Render dashboard
- **Database**: Monitor slow queries in Render database dashboard

## Next Steps

After successful deployment:

1. Test authentication endpoints
2. Verify database connectivity
3. Test frontend-backend integration
4. Monitor application logs
5. Set up custom domain (optional)
6. Configure monitoring alerts (optional)

## URLs

After deployment, your services will be available at:

- **Frontend**: `https://ecompta-frontend.onrender.com`
- **Backend API**: `https://ecompta-backend.onrender.com`
- **Health Check**: `https://ecompta-backend.onrender.com/actuator/health`

---

**Last Updated**: October 2025
**Configuration Version**: 2.0.0
