# Render Deployment Configuration Guide

## Overview

This guide explains the production-ready configuration for deploying E-COMPTA-IA-LIGHT on Render using Docker containers for both frontend and backend services.

## Architecture

The application is deployed as two separate services on Render:

1. **Backend Service** (Docker/Spring Boot) - ecompta-backend
2. **Frontend Service** (Docker/React + Nginx) - ecompta-frontend
3. **PostgreSQL Database** - postgres

## Why Docker on Render?

After testing, we've determined that Docker-based deployment is the most reliable approach for Render's free tier:

- ✅ **Consistent environment** across development and production
- ✅ **Better compatibility** with Render's free tier
- ✅ **Proven stability** for both Java and Node.js applications
- ✅ **Multi-stage builds** for optimized image sizes
- ✅ **Health check support** via actuator endpoints

## Configuration Files

### 1. render.yaml (Automatic Deployment)

The `render.yaml` file in the project root contains the complete configuration for automatic deployment via Render Blueprint.

**Key Features:**
- Docker-based deployment for both services
- Automatic database connection setup
- Health checks enabled
- Free tier configuration

### 2. Backend Configuration

#### Dockerfile.backend

**Multi-stage build:**
1. **Build stage**: Uses Maven to compile with production profile
2. **Runtime stage**: Lightweight JRE-only image

**Features:**
- Production profile activated (`-Pprod`)
- Dynamic port binding from Render's `$PORT` variable
- Spring Boot profile set to `prod`

#### Application Configuration (`backend/src/main/resources/application-prod.yml`)

**Features:**
- PostgreSQL database connection with HikariCP connection pooling
- Actuator endpoints for health monitoring
- Production-optimized logging
- Port configuration from environment variable
- H2 console disabled for security

**Environment Variables Required:**
- `SPRING_PROFILES_ACTIVE=prod`
- `JWT_SECRET` (auto-generated by Render)
- `JWT_EXPIRATION=86400000` (24 hours)
- Database variables (auto-injected from database service)

#### Security Configuration

**CORS Configuration** (`WebConfig.java`):
- Allows requests from Render frontend domain
- Configured for API endpoints only
- Credentials support enabled

**Security Endpoints** (`SecurityConfig.java`):
- `/actuator/health` - Public health check
- `/actuator/info` - Public info endpoint
- `/api/auth/**` - Public authentication endpoints

### 3. Frontend Configuration

#### Dockerfile (frontend-app/Dockerfile)

**Multi-stage build:**
1. **Build stage**: Compiles React application with npm
2. **Runtime stage**: Nginx serving static files

**Features:**
- Nginx configured for SPA routing (`try_files`)
- Environment variable support for API URL
- Optimized Alpine-based images

#### Package Configuration (`frontend-app/package.json`)

**Key Changes:**
- `"homepage": "."` - Enables relative paths for static deployment

#### Environment Configuration (`frontend-app/.env.production`)

```env
REACT_APP_API_URL=https://ecompta-backend.onrender.com
```

This ensures the frontend connects to the correct backend service.

#### HTML Metadata (`frontend-app/public/index.html`)

Updated with:
- Proper title: "E-COMPTA-IA-LIGHT - Comptabilité Intelligente"
- SEO-friendly meta description
- Keywords for better discoverability

## Deployment Process

### Automatic Deployment (Recommended)

1. Push changes to GitHub
2. In Render Dashboard:
   - Go to "Blueprints"
   - Click "New Blueprint Instance"
   - Connect your repository
   - Select the branch
3. Render will automatically:
   - Create the database
   - Build and deploy the backend Docker image
   - Build and deploy the frontend Docker image
   - Link all services together

### Manual Deployment (Alternative)

If you prefer manual setup:

#### Database
1. Create PostgreSQL database: "postgres"
2. Note the connection details

#### Backend Service
1. New Web Service
2. Environment: Docker
3. Dockerfile Path: `./Dockerfile.backend`
4. Add environment variables (see render.yaml for complete list)
5. Link to database
6. Health Check Path: `/actuator/health`

#### Frontend Service
1. New Web Service
2. Environment: Docker
3. Dockerfile Path: `./frontend-app/Dockerfile`
4. Docker Context: `./frontend-app`
5. Add environment variable: `REACT_APP_API_URL=https://ecompta-backend.onrender.com`

## Health Monitoring

The backend exposes health check endpoints:

- **Health:** `https://ecompta-backend.onrender.com/actuator/health`
- **Info:** `https://ecompta-backend.onrender.com/actuator/info`

Render automatically monitors the `/actuator/health` endpoint and will restart the service if it becomes unhealthy.

## Build Verification

### Backend Build Test

```bash
cd backend
mvn clean package -DskipTests -Pprod
```

**Expected Output:**
- BUILD SUCCESS
- JAR file: `target/ecompta-ia-light-2.0.0.jar` (~60MB)
- Includes actuator dependencies

### Frontend Build Test

```bash
cd frontend-app
npm install
npm run build
```

**Expected Output:**
- Compiled successfully
- Build folder created with optimized assets
- Assets use relative paths (./static/...)

### Docker Build Test

```bash
# Backend
docker build -f Dockerfile.backend -t backend-test .

# Frontend
docker build -f frontend-app/Dockerfile -t frontend-test ./frontend-app
```

## Troubleshooting

### Frontend Shows Blank Page

**Check:**
1. Nginx configuration for SPA routing
2. Browser console for API connection errors
3. CORS configuration in backend
4. `REACT_APP_API_URL` environment variable

### Backend Deployment Fails

**Check:**
1. Docker build logs for compilation errors
2. Database connection environment variables
3. `JWT_SECRET` is set
4. Maven build completes successfully with `-Pprod` profile

### Database Connection Issues

**Check:**
1. Database service is running
2. Environment variables are correctly linked
3. PostgreSQL version compatibility
4. Connection pool settings

### Health Check Failing

**Check:**
1. `/actuator/health` endpoint is accessible
2. Security configuration allows public access
3. Backend is fully started (check logs)
4. Docker container is running

## Performance Optimization

### Backend
- Multi-stage Docker build reduces image size
- HikariCP connection pooling (max 10 connections)
- JVM optimizations in Docker entrypoint
- Production profile with optimized settings

### Frontend
- Multi-stage Docker build
- Nginx serving static files (fast)
- Gzipped assets
- Code splitting with lazy loading
- Optimized production build

## Security Considerations

1. **JWT Secret**: Auto-generated by Render (secure)
2. **CORS**: Restricted to frontend domain
3. **H2 Console**: Disabled in production
4. **HTTPS**: Enforced by Render
5. **Database**: Isolated within Render network
6. **Environment Variables**: Stored securely by Render
7. **Docker Images**: Based on official images only

## Support

For issues specific to:
- **Render Platform**: Check Render's status page and documentation
- **Application Code**: Check application logs in Render dashboard
- **Database**: Monitor slow queries in Render database dashboard
- **Docker Builds**: Check build logs in Render dashboard

## Next Steps

After successful deployment:

1. Test authentication endpoints
2. Verify database connectivity
3. Test frontend-backend integration
4. Monitor application logs
5. Set up custom domain (optional)
6. Configure monitoring alerts (optional)

## URLs

After deployment, your services will be available at:

- **Frontend**: `https://ecompta-frontend.onrender.com`
- **Backend API**: `https://ecompta-backend.onrender.com`
- **Health Check**: `https://ecompta-backend.onrender.com/actuator/health`

---

**Last Updated**: October 2025  
**Configuration Version**: 2.1.0 (Docker-based)  
**Status**: ✅ Production Ready
